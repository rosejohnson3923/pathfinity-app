/**
 * PromptBuilder - Combines hierarchical rules to generate consistent AI prompts
 * This centralizes prompt generation and ensures all rules are applied
 */

import {
  UNIVERSALCONTENT_RULES,
  formatUniversalRulesForPrompt,
  getLanguageConstraintsOnly,
  validateQuestionStructure
} from './rules/UniversalContentRules';

import {
  UNIVERSALSUBJECT_RULES,
  formatSubjectRulesForPrompt,
  getAllowedTypes,
  validateSubjectRules
} from './rules/UniversalSubjectRules';

import {
  LEARNCONTAINER_RULES,
  formatLearnContainerRulesForPrompt,
  getLearnContainerRequirements,
  getLearnContainerInstructions,
  validateLearnContainerRules,
  getLearnExampleStructure,
  getLearnResponseFormat,
  getLearnQualityChecklist,
  getLearnReminders,
  getELALetterRules
} from './rules/LearnContainerRules';

import {
  EXPERIENCECONTAINER_RULES,
  formatExperienceContainerRulesForPrompt,
  getExperienceContainerRequirements,
  getExperienceContainerInstructions,
  validateExperienceContainerRules,
  getExperienceTaskInstructions,
  getExperienceResponseFormat,
  getExperienceExampleStructure,
  getExperienceQualityChecklist,
  getExperienceReminders,
  getExperienceOverrides
} from './rules/ExperienceContainerRules';

import {
  DISCOVERCONTAINER_RULES,
  formatDiscoverContainerRulesForPrompt,
  getDiscoverContainerRequirements,
  getDiscoverContainerInstructions,
  validateDiscoverContainerRules,
  getDiscoverTaskInstructions,
  getDiscoverResponseFormat,
  getDiscoverQualityChecklist,
  getDiscoverReminders,
  getDiscoverExampleStructure,
  getDiscoverOverrides
} from './rules/DiscoverContainerRules';

export interface PromptContext {
  container: 'LEARN' | 'DISCOVER' | 'EXPERIENCE' | 'ASSESSMENT';
  subject: string;
  grade: string;
  skill: {
    id: string;
    name: string;
    description?: string;
    subject: string;
  };
  career: {
    id: string;
    name: string;
    description?: string;
  };
  student: {
    id: string;
    display_name: string;
    grade_level: string;
  };
  companion?: {
    name: string;
    personality?: string;
  };
  // Narrative context from MasterNarrative
  narrativeContext?: {
    setting?: string;
    context?: string;
    narrative?: string;
    mission?: string;
    throughLine?: string;
    companion?: any;
    subjectContext?: any;
  };
}

export class PromptBuilder {
  private static instance: PromptBuilder;
  
  private constructor() {}
  
  static getInstance(): PromptBuilder {
    if (!PromptBuilder.instance) {
      PromptBuilder.instance = new PromptBuilder();
    }
    return PromptBuilder.instance;
  }
  
  /**
   * Build a complete prompt combining all rule levels
   */
  buildPrompt(context: PromptContext): string {
    const { container, subject, grade, skill, career, student, companion } = context;

    // Get allowed types for this subject/grade
    const allowedTypes = getAllowedTypes(subject, grade);

    // Get container-specific requirements and overrides
    const requirements = this.getContainerRequirements(container);
    const overrides = this.getContainerOverrides(container);

    // Add pre-generation validation for ELA
    const preValidation = skill.subject === 'ELA' ? `
‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è STOP AND READ - CRITICAL VALIDATION ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

You are about to generate content for:
- Subject: ELA (English Language Arts)
- Skill: ${skill.name}
- Grade: ${grade}

BEFORE YOU GENERATE ANYTHING, CONFIRM:
‚úì You will ONLY ask about letters, vowels, and consonants
‚úì You will NEVER ask "Which number comes first: 1, 2, or 3?"
‚úì You will use Title Case words like "Game" not "GAME"
‚úì Example question: "Is the letter E a consonant or a vowel?"

If you generate ANY Math content for this ELA lesson, the entire response will be REJECTED.

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è END CRITICAL VALIDATION ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
` : '';

    // Add narrative context if available
    const narrativeSection = context.narrativeContext ? `
========================================
NARRATIVE CONTEXT - MAINTAIN CONTINUITY
========================================
${context.narrativeContext.setting ? `Setting: ${context.narrativeContext.setting}` : ''}
${context.narrativeContext.narrative ? `Story: ${context.narrativeContext.narrative}` : ''}
${context.narrativeContext.mission ? `Mission: ${context.narrativeContext.mission}` : ''}
${context.narrativeContext.throughLine ? `Career Connection: ${context.narrativeContext.throughLine}` : ''}
${context.narrativeContext.context ? `Context: ${context.narrativeContext.context}` : ''}
${context.narrativeContext.companion ? `
Companion: ${context.narrativeContext.companion.name || 'AI Assistant'}
Personality: ${context.narrativeContext.companion.personality || ''}
Teaching Style: ${context.narrativeContext.companion.teachingStyle || ''}
` : ''}

CRITICAL: All content must align with this narrative context!
========================================
` : '';

    // Build the complete prompt based on container type
    const prompt = `
You are an expert educational content creator specializing in personalized, gamified learning experiences.

${preValidation}

${narrativeSection}

${this.getSystemContext(student, career, skill, companion)}

${overrides.useLanguageConstraintsOnly ? getLanguageConstraintsOnly(grade) : formatUniversalRulesForPrompt(grade)}

${overrides.skipSubjectRules ? '' : formatSubjectRulesForPrompt(subject, grade)}

${this.getContainerRules(container, career.name)}

${subject === 'ELA' && (container === 'LEARN' || container === 'ASSESSMENT') ? getELALetterRules(grade, skill.name) : ''}

${subject === 'MATH' && ['K', '1', '2'].includes(grade) ? this.getCountingQuestionRules(career.name) : ''}

${this.getTaskInstructions(context)}

${this.getResponseFormat(container, requirements, allowedTypes, context)}

${this.getExampleStructure(container, career.name, subject)}

${this.getQualityChecklist(container)}

${this.getContainerReminders(container, subject, grade, career.name)}

${skill.subject === 'ELA' ? `
‚ö†Ô∏è FINAL REMINDER BEFORE GENERATING:
- This is ELA about "${skill.name}"
- ONLY generate questions about letters/vowels/consonants
- Use "Game" not "GAME", "Play" not "PLAY"
- NO MATH QUESTIONS ALLOWED
` : ''}

Generate the content now:
`;

    return prompt;
  }
  
  /**
   * Get container-specific requirements
   */
  private getContainerRequirements(container: string): any {
    switch (container) {
      case 'LEARN':
      case 'ASSESSMENT':
        return getLearnContainerRequirements(container);
      case 'EXPERIENCE':
        return getExperienceContainerRequirements(container);
      case 'DISCOVER':
        return getDiscoverContainerRequirements(container);
      default:
        return { exampleCount: 3, practiceCount: 5, assessmentCount: 1, requiresSupport: true };
    }
  }

  /**
   * Get container-specific overrides
   */
  private getContainerOverrides(container: string): any {
    switch (container) {
      case 'EXPERIENCE':
        return getExperienceOverrides();
      case 'DISCOVER':
        return getDiscoverOverrides();
      case 'LEARN':
      case 'ASSESSMENT':
      default:
        return { skipSubjectRules: false, useLanguageConstraintsOnly: false };
    }
  }

  /**
   * Get container-specific rules
   */
  private getContainerRules(container: string, careerName: string): string {
    switch (container) {
      case 'LEARN':
      case 'ASSESSMENT':
        return formatLearnContainerRulesForPrompt(container, careerName);
      case 'EXPERIENCE':
        return formatExperienceContainerRulesForPrompt(container, careerName);
      case 'DISCOVER':
        return formatDiscoverContainerRulesForPrompt(container, careerName);
      default:
        return '';
    }
  }

  /**
   * Get container-specific reminders
   */
  private getContainerReminders(container: string, subject: string, grade: string, careerName: string): string {
    switch (container) {
      case 'LEARN':
      case 'ASSESSMENT':
        return getLearnReminders(subject, grade);
      case 'EXPERIENCE':
        return getExperienceReminders(careerName, grade);
      case 'DISCOVER':
        return getDiscoverReminders(subject, grade, careerName);
      default:
        return '';
    }
  }

  /**
   * Build system context section
   */
  private getSystemContext(
    student: any,
    career: any,
    skill: any,
    companion?: any
  ): string {
    return `
========================================
LEARNING CONTEXT
========================================
Student: ${student.display_name} (Grade ${student.grade_level})
Career Context: ${career.name}
Skill: ${skill.name}
Subject: ${skill.subject}
${companion ? `AI Companion: ${companion.name}` : ''}

Your task is to create an engaging, career-integrated learning experience that helps ${student.display_name} master "${skill.name}" while seeing how ${career.name}s use this skill professionally.

‚ö†Ô∏è CRITICAL SUBJECT ISOLATION - MANDATORY:
‚Ä¢ You are teaching ${skill.subject} ONLY - NO EXCEPTIONS!
‚Ä¢ NEVER mix subjects - this is a CRITICAL ERROR

${skill.subject === 'ELA' ? `
üî¥ ELA SPECIFIC - ABSOLUTELY FORBIDDEN:
  ‚ùå NEVER ask "Which number comes first: 1, 2, or 3?"
  ‚ùå NEVER use Math counting questions
  ‚ùå NEVER use numeric ordering
  ‚úÖ ONLY focus on: letters, vowels, consonants, words, sentences
  ‚úÖ Example: "Is the letter E a consonant or a vowel?"
  ‚úÖ Example: "Which letter in 'Game' is uppercase?"
` : ''}

${skill.subject === 'MATH' ? `
üî¥ MATH SPECIFIC - ABSOLUTELY FORBIDDEN:
  ‚ùå NEVER ask about consonants and vowels
  ‚ùå NEVER ask about letter identification
  ‚úÖ ONLY focus on: numbers, counting, operations, patterns
` : ''}

ENFORCEMENT:
‚Ä¢ If teaching ${skill.subject}, ALL questions MUST be about ${skill.subject}
‚Ä¢ Topic: "${skill.name}" - stay focused on this specific skill
‚Ä¢ Any cross-subject content will cause COMPLETE FAILURE
`;
  }
  
  /**
   * Get specific task instructions based on container
   */
  private getTaskInstructions(context: PromptContext): string {
    const { container, student, career, skill, subject } = context;

    switch (container) {
      case 'EXPERIENCE':
        return getExperienceTaskInstructions(
          student.display_name,
          career.name,
          skill.name,
          student.grade_level
        );

      case 'DISCOVER':
        return getDiscoverTaskInstructions(
          student.display_name,
          career.name,
          subject,
          skill.name,
          student.grade_level
        );

      case 'LEARN':
      case 'ASSESSMENT':
      default:
        const instructions = getLearnContainerInstructions(
          container,
          career.name,
          student.display_name,
          student.grade_level
        );
        return `
========================================
YOUR TASK
========================================
${instructions}

Create content that:
‚Ä¢ Is appropriate for grade ${student.grade_level}
‚Ä¢ Integrates ${career.name} context naturally
‚Ä¢ Follows all universal, subject, and container rules
‚Ä¢ Maintains consistent formatting and structure
‚Ä¢ Provides supportive, encouraging feedback
`;
    }
  }
  
  /**
   * Get the expected response format
   */
  private getResponseFormat(
    container: string,
    requirements: any,
    allowedTypes: string[],
    context?: PromptContext
  ): string {
    switch (container) {
      case 'EXPERIENCE':
        return getExperienceResponseFormat(requirements);

      case 'DISCOVER':
        // Add context to requirements for Discover
        const discoverRequirements = {
          ...requirements,
          career: context?.career?.name,
          subject: context?.subject,
          skill: context?.skill?.name,
          studentName: context?.student?.display_name
        };
        return getDiscoverResponseFormat(discoverRequirements, allowedTypes);

      case 'LEARN':
      case 'ASSESSMENT':
        return getLearnResponseFormat(requirements, allowedTypes);

      default:
        // Fallback to basic format
        return getLearnResponseFormat(requirements, allowedTypes);
    }
  }
  
  /**
   * Provide a concrete example structure
   */
  private getExampleStructure(container: string, careerName: string, subject: string): string {
    switch (container) {
      case 'EXPERIENCE':
        return getExperienceExampleStructure();

      case 'DISCOVER':
        return getDiscoverExampleStructure(careerName, subject);

      case 'LEARN':
      case 'ASSESSMENT':
        return getLearnExampleStructure();

      default:
        return ``;
    }
  }
  
  /**
   * Quality checklist reminder
   */
  private getQualityChecklist(container?: string): string {
    switch (container) {
      case 'EXPERIENCE':
        return getExperienceQualityChecklist();

      case 'DISCOVER':
        return getDiscoverQualityChecklist();

      case 'LEARN':
      case 'ASSESSMENT':
        return getLearnQualityChecklist();

      default:
        // This should never be reached since all containers have their own checklists
        console.warn(`No quality checklist found for container: ${container}`);
        return '';
    }
  }
  
  /**
   * Validate generated content against all rules
   */
  validateContent(content: any, context: PromptContext): {
    valid: boolean;
    errors: string[];
    warnings: string[];
  } {
    const errors: string[] = [];
    const warnings: string[] = [];
    
    // Validate container requirements based on container type
    let containerErrors: string[] = [];
    switch (context.container) {
      case 'LEARN':
      case 'ASSESSMENT':
        containerErrors = validateLearnContainerRules(content, context.container);
        break;
      case 'EXPERIENCE':
        containerErrors = validateExperienceContainerRules(content, context.container);
        break;
      case 'DISCOVER':
        containerErrors = validateDiscoverContainerRules(content, context.container);
        break;
    }
    errors.push(...containerErrors);
    
    // Validate each practice question
    if (content.practice && Array.isArray(content.practice)) {
      content.practice.forEach((question: any, index: number) => {
        // Universal validation
        const universalErrors = validateQuestionStructure(question);
        errors.push(...universalErrors.map(e => `Practice ${index + 1}: ${e}`));
        
        // Subject validation
        const subjectErrors = validateSubjectRules(question, context.subject, context.grade);
        errors.push(...subjectErrors.map(e => `Practice ${index + 1}: ${e}`));
        
        // Check practiceSupport
        if (context.container !== 'ASSESSMENT' && !question.practiceSupport) {
          errors.push(`Practice ${index + 1}: Missing required practiceSupport structure`);
        }
      });
    }
    
    // Validate assessment
    if (content.assessment) {
      const assessmentErrors = validateQuestionStructure(content.assessment);
      errors.push(...assessmentErrors.map(e => `Assessment: ${e}`));
      
      const subjectErrors = validateSubjectRules(content.assessment, context.subject, context.grade);
      errors.push(...subjectErrors.map(e => `Assessment: ${e}`));
    }
    
    return {
      valid: errors.length === 0,
      errors,
      warnings
    };
  }
  
  /**
   * Get counting question rules for K-2 Math with career-appropriate emojis
   */
  private getCountingQuestionRules(careerName?: string): string {
    // Career-specific emoji mappings
    const careerEmojiMap: Record<string, string> = {
      // Sports & Fitness
      'Coach': '‚öΩüèÄüèàüéæüèê‚öæü•éüèèüè∏üèìüèíüèëü•çü•äü§∫‚õπÔ∏èü§∏üèãÔ∏èüëïüèÜü•áü•àü•âüèÖüì£', // Note: No whistle emoji exists, use üì£ (megaphone) for coach communication
      'Athletic Trainer': '‚öΩüèÄüèàüéæüí™ü¶µü¶∂üèÉü§∏‚õπÔ∏èü©πüßäüíäüè•',
      'Sports Referee': '‚öΩüèÄüèà‚öæüèêüì£üö©üü®üü•‚úãüëÅÔ∏èüìãüìä',

      // Medical & Healthcare
      'Doctor': 'ü©∫üíäüíâüè•üî¨üß™ü©πüå°Ô∏èüè•üìãüß¨ü¶¥ü´Äü´Å',
      'Nurse': 'ü©∫üíäüíâüè•ü©πüå°Ô∏èüìãüß¥üíäüè•',
      'Veterinarian': 'üê∂üê±üê≠üêπüê∞ü¶äüêªüêºüê®üêØü¶ÅüêÆüê∑üê∏ü©∫üíâ',

      // Creative Arts
      'Artist': 'üé®üñåÔ∏èüñçÔ∏è‚úèÔ∏èüìêüñºÔ∏èüé≠üñäÔ∏èüìèüìê',
      'Musician': 'üéµüé∂üéºüéπüé∏ü•Åüé∑üé∫üéªü™ïüé§üéß',
      'Chef': 'üç≥ü•òüç≤ü•óüçïüçîüçüüåÆüåØü•ôüßÜüçúüç±ü•°üî™ü•Ñ',

      // Technology
      'Video Game Designer': 'üéÆüïπÔ∏èüíªüñ•Ô∏èüñ±Ô∏è‚å®Ô∏èüéØüëæü§ñüèÜüíé‚öîÔ∏èüõ°Ô∏è',
      'Computer Programmer': 'üíªüñ•Ô∏è‚å®Ô∏èüñ±Ô∏èüíæüíøüìÄüñ®Ô∏èüì±‚öôÔ∏èüîßüî®',

      // Education
      'Teacher': 'üìöüìñüìù‚úèÔ∏èüìèüìêüñçÔ∏èüé®üî§üî¢üßÆüóÇÔ∏è',
      'Librarian': 'üìöüìñüìïüìóüìòüìôüììüìîüìëüîñüì∞üóûÔ∏è',

      // Science & Research
      'Scientist': 'üî¨üß™üß´ü¶†üíâüß¨üî≠üå°Ô∏è‚öóÔ∏èü•Ωüìäüìà',
      'Astronaut': 'üöÄüõ∏üååüåçüåéüåèüåô‚≠êü™ê‚òÑÔ∏èüõ∞Ô∏èüë®‚ÄçüöÄ',
      'Marine Biologist': 'üê†üêüüê°ü¶àüêôü¶ëü¶êü¶ûü¶Äüêöüêãüê¨',
      'Archeologist': 'üè∫‚ö±Ô∏èüóøü¶¥ü¶ñüîçüó∫Ô∏è‚õèÔ∏èüèõÔ∏èüìú',
      'Geologist': '‚õ∞Ô∏èüåãü™®üíé‚õèÔ∏èüîçüó∫Ô∏èüåçüìäüìà',

      // Business & Finance
      'Entrepreneur': 'üíºüí∞üí≥üìäüìàüí°üè¢ü§ùüì±üíª',
      'Accountant': 'üí∞üíµüí¥üí∂üí∑üìäüìàüìâüßÆüí≥',
      'Financial Advisor': 'üí∞üìäüìàüí≥üè¶üíµüìëüìãüíºü§ù',
      'Real Estate Agent': 'üè†üè°üè¢üèòÔ∏èüîëüìãü§ùüíºüìêüìè',

      // Transportation & Logistics
      'Pilot': '‚úàÔ∏èüõ©Ô∏èüõ´üõ¨üåçüó∫Ô∏èüì°üéõÔ∏èüë®‚Äç‚úàÔ∏èüë©‚Äç‚úàÔ∏è',
      'Truck Driver': 'üööüöõüì¶üìãüó∫Ô∏è‚õΩüõ£Ô∏èüö¶‚ö†Ô∏èüîß',
      'Ship Captain': 'üö¢‚õ¥Ô∏è‚öìüåäüó∫Ô∏èüì°üß≠‚õµüåÖüêã',

      // Law & Public Service
      'Lawyer': '‚öñÔ∏èüìöüìãüèõÔ∏èüíºüìù‚úçÔ∏èü§ùüëîüìë',
      'Police Officer': 'üëÆüöîüö®üìãüî¶üöì‚öñÔ∏èüõ°Ô∏èüìªüöÅ',
      'Firefighter': 'üöíüî•üßØüë®‚Äçüöíü™úüö®üíßüè¢‚õëÔ∏èüÜò',
      'Judge': '‚öñÔ∏èüî®üìöüèõÔ∏èüìãüë®‚Äç‚öñÔ∏èüë©‚Äç‚öñÔ∏èüìù‚úçÔ∏è‚ö°',

      // Agriculture & Environment
      'Farmer': 'üåæüåΩü•ïü•îüçÖüöúüêÑüêñüêìüåª',
      'Gardener': 'üåªüå∑üåπüå∫üå∏üåøüçÄüå±üå≤üå≥',
      'Environmental Scientist': 'üåçüå±üå≥üíßüåä‚ôªÔ∏èüìäüìàüî¨üß™',
      'Park Ranger': 'üå≤üèûÔ∏èü¶åüêªüó∫Ô∏èü•æ‚õ∫üî•üéíüì∑',

      // Construction & Trades
      'Construction Worker': 'üë∑üèóÔ∏èüß±üî®ü™õ‚öíÔ∏èü™úüìêüìèüöß',
      'Electrician': 'üí°üîå‚ö°üîãü™õüîßüìê‚ö†Ô∏èüë∑üíª',
      'Plumber': 'üîßüö∞üíßüöøüõÅü™†üî©üë∑üìê‚ö†Ô∏è',
      'Carpenter': 'ü™µüî®ü™õüìêüìèü™öüóúÔ∏èüë∑üè†üö™',

      // Media & Entertainment
      'Actor': 'üé≠üé¨üé•üì∫üé™üåüüëîüëóüíÑüé§',
      'Director': 'üé¨üé•üìπüéûÔ∏èüìΩÔ∏èüé™üì¢üìã‚úÇÔ∏èüåü',
      'Photographer': 'üì∑üì∏üìπüñºÔ∏èüí°üé®üåÖüåÑüèûÔ∏èüìê',
      'Journalist': 'üì∞üóûÔ∏èüìù‚úçÔ∏èüìªüì∫üé§üìπüíªüóÇÔ∏è',

      // Service Industry
      'Barber': '‚úÇÔ∏èüíàüëîü™íüß¥üíá‚Äç‚ôÇÔ∏èüíá‚Äç‚ôÄÔ∏èü™ëüìãüíµ',
      'Beautician': 'üíÑüíÖüíá‚Äç‚ôÄÔ∏è‚úÇÔ∏èüß¥üíÜ‚Äç‚ôÄÔ∏èüëóüíçüìãüíµ',
      'Hotel Manager': 'üè®üîëüõéÔ∏èüõèÔ∏èüçΩÔ∏èüìãüíºü§ùüìûüí≥',
      'Travel Agent': '‚úàÔ∏èüèñÔ∏èüó∫Ô∏èüé´üè®üö¢üìãüíºüåçüìû',

      // Default fallback emojis for any career
      'default': '‚≠êüì¶üéÅüéàüéØüîµüî¥üü°üü¢üü£üü†‚ö´‚ö™'
    };

    // Get career-appropriate emojis
    const careerEmojis = careerEmojiMap[careerName || ''] || careerEmojiMap['default'];

    return `
========================================
üî¥üî¥üî¥ STOP - CRITICAL COUNTING QUESTION RULES üî¥üî¥üî¥
========================================

‚õî‚õî‚õî ABSOLUTE PROHIBITION ‚õî‚õî‚õî
THE QUESTION TEXT MUST NEVER CONTAIN ANY EMOJIS!
THE QUESTION TEXT MUST NEVER CONTAIN ANY EMOJIS!
THE QUESTION TEXT MUST NEVER CONTAIN ANY EMOJIS!

ALL EMOJIS GO IN THE 'visual' FIELD ONLY!

üö´ COMPLETELY FORBIDDEN - WILL FAIL VALIDATION:
{
  "question": "How many basketballs are there? üèÄüèÄüèÄ",  ‚Üê WRONG! Has emojis!
  "visual": "üèÄüèÄüèÄ"
}

‚úÖ ONLY CORRECT FORMAT:
{
  "question": "How many basketballs are there?",  ‚Üê RIGHT! No emojis in text!
  "visual": "üèÄüèÄüèÄ"  ‚Üê Emojis ONLY here!
}

========================================
MANDATORY COUNTING QUESTION STRUCTURE
========================================

1. question field: PURE TEXT ONLY - NO EMOJIS EVER!
2. visual field: ALL EMOJIS GO HERE AND ONLY HERE!
3. correct_answer: The count number

üéØ CAREER-APPROPRIATE EMOJI SELECTION:
${careerName ? `For ${careerName}, use ONLY these emojis IN THE VISUAL FIELD: ${careerEmojis}` : 'Use generic counting objects: ‚≠êüì¶üéÅüéàüéØ'}

========================================
‚úÖ CORRECT EXAMPLES FOR ${careerName || 'ANY CAREER'}
========================================

EXAMPLE 1:
{
  "question": "How many sports balls are on the field?",
  "visual": "‚öΩüèÄüèà",
  "correct_answer": 3
}

EXAMPLE 2:
{
  "question": "Count the items above",
  "visual": "üèÜüèÜ",
  "correct_answer": 2
}

EXAMPLE 3:
{
  "question": "How many ${careerName === 'Coach' ? 'uniforms' : 'items'} does ${careerName || 'the professional'} need?",
  "visual": "${careerName === 'Coach' ? 'üëïüëïüëïüëï' : '‚≠ê‚≠ê‚≠ê‚≠ê'}",
  "correct_answer": 4
}

========================================
‚ùå NEVER GENERATE THESE WRONG FORMATS
========================================

WRONG 1 - Emojis in question text:
{
  "question": "How many are there? üèÄüèÄüèÄ",  ‚Üê EMOJIS IN QUESTION = WRONG!
  "visual": "üèÄüèÄüèÄ"
}

WRONG 2 - Emojis embedded in sentence:
{
  "question": "The coach sees üèÄüèÄ. How many?",  ‚Üê EMOJIS IN QUESTION = WRONG!
  "visual": "üèÄüèÄ"
}

WRONG 3 - Any emoji anywhere in question:
{
  "question": "Count these items: ‚öΩ‚öΩ‚öΩ",  ‚Üê EMOJIS IN QUESTION = WRONG!
  "visual": "‚öΩ‚öΩ‚öΩ"
}

========================================
FINAL REMINDER - THIS IS CRITICAL
========================================

Before generating EACH counting question, verify:
‚òê Question text has ZERO emojis (not a single one!)
‚òê Visual field contains ALL the emojis
‚òê Question refers to items generically or by career context
‚òê Emojis in visual field match the career (${careerName || 'generic'})

If you put ANY emoji in the question text, the entire response will be REJECTED!`;
  }

  /**
   * Generate a simplified prompt for quick testing
   */
  buildSimplePrompt(
    subject: string,
    grade: string,
    questionType: string,
    includeSupport: boolean = true
  ): string {
    const rules = UNIVERSALCONTENT_RULES.ANSWER_FORMATS[questionType as keyof typeof UNIVERSALCONTENT_RULES.ANSWER_FORMATS];

    return `
Generate a ${questionType} question for ${subject}, grade ${grade}.

MANDATORY FIELDS:
- question
- type: "${questionType}"
- visual: (use "‚ùì" for text-only)
- correct_answer: ${rules?.format || 'appropriate format'}
- hint
- explanation
${includeSupport ? '- practiceSupport (full structure)' : ''}

correct_answer format: ${rules?.aiInstruction || 'see rules'}

Generate now in JSON format:
`;
  }
}

// Export singleton instance
export const promptBuilder = PromptBuilder.getInstance();