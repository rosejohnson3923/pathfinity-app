<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovered Live! Multiplayer Test Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }
        .bingo-square {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.3s;
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
            padding: 0.5rem;
        }
        .bingo-square.unlocked {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            transform: scale(1.05);
        }
        .bingo-square.center {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            font-weight: bold;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .player-card {
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .player-card.current-user {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
        }
        .career-name {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white/80 backdrop-blur-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">üéÆ Discovered Live! Multiplayer Test</h1>
                    <p class="text-sm text-gray-600 mt-1">Complete multiplayer game simulation with AI opponents</p>
                </div>
                <button onclick="toggleSettings()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Panel (Hidden by default) -->
    <div id="settingsPanel" class="hidden max-w-7xl mx-auto px-4 py-4">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Test Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Number of Players</label>
                    <input type="number" id="numPlayers" value="6" min="2" max="10"
                           class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Questions Per Game</label>
                    <input type="number" id="numQuestions" value="20" min="5" max="30"
                           class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Timer Duration (seconds)</label>
                    <input type="number" id="timerDuration" value="8" min="5" max="30"
                           class="w-full px-4 py-2 border rounded-lg">
                </div>
            </div>
        </div>
    </div>

    <!-- START GAME BUTTON (Always Visible) -->
    <div class="max-w-7xl mx-auto px-4 py-4">
        <button onclick="startGame()" class="w-full px-8 py-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-black text-2xl hover:scale-105 transition-transform shadow-2xl">
            üöÄ START NEW GAME
        </button>
    </div>

    <!-- Main Game Area -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Game Status -->
        <div id="gameStatus" class="mb-6 bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold">Room: <span id="roomCode" class="text-purple-600">TEST-ROOM</span></h2>
                    <p class="text-sm text-gray-600">Status: <span id="gameState" class="font-semibold">Waiting to start...</span></p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-black" id="timerDisplay">--</div>
                    <p class="text-xs text-gray-600">Time Remaining</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Current Question -->
            <div class="lg:col-span-2">
                <div id="questionCard" class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-start gap-4">
                        <div class="w-14 h-14 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center text-white font-black text-xl">
                            <span id="questionNumber">-</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2" id="questionText">Waiting for question...</h3>
                            <p class="text-sm text-gray-600" id="skillConnection">-</p>
                        </div>
                    </div>
                </div>

                <!-- Your Bingo Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4">Your Bingo Card</h3>
                    <div class="bingo-grid" id="myBingoGrid">
                        <!-- Grid will appear here when game starts -->
                        <div class="col-span-5 text-center p-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-500 text-sm">Click "START NEW GAME" to generate your bingo card!</p>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center justify-between text-sm">
                        <span>Unlocked: <span id="unlockedCount" class="font-bold text-green-600">0</span>/25</span>
                        <span>Bingos: <span id="bingoCount" class="font-bold text-yellow-600">0</span></span>
                        <span>XP: <span id="xpCount" class="font-bold text-purple-600">0</span></span>
                    </div>
                </div>
            </div>

            <!-- Players List -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4">Players (Leaderboard)</h3>
                    <div id="playersList" class="space-y-3">
                        <p class="text-gray-500 text-sm text-center py-4">Players will appear here when game starts</p>
                    </div>
                </div>

                <!-- Event Log -->
                <div class="mt-6 bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4">Event Log</h3>
                    <div id="eventLog" class="space-y-2 max-h-64 overflow-y-auto text-sm">
                        <p class="text-gray-500 italic">No events yet...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Modal (Hidden) -->
        <div id="resultsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-8">
                    <h2 class="text-3xl font-black mb-6 text-center">üéâ Game Complete! üéâ</h2>

                    <!-- Podium -->
                    <div class="flex items-end justify-center gap-4 mb-8">
                        <div id="podium2" class="text-center p-4 bg-gray-300 rounded-t-xl" style="height: 120px;">
                            <div class="text-4xl mb-2">ü•à</div>
                            <div class="font-bold">2nd</div>
                            <div class="text-sm" id="podium2Name">-</div>
                            <div class="text-xs" id="podium2XP">0 XP</div>
                        </div>
                        <div id="podium1" class="text-center p-4 bg-yellow-400 rounded-t-xl" style="height: 160px;">
                            <div class="text-5xl mb-2">üèÜ</div>
                            <div class="font-bold">1st</div>
                            <div class="text-sm" id="podium1Name">-</div>
                            <div class="text-xs" id="podium1XP">0 XP</div>
                        </div>
                        <div id="podium3" class="text-center p-4 bg-orange-400 rounded-t-xl" style="height: 100px;">
                            <div class="text-3xl mb-2">ü•â</div>
                            <div class="font-bold">3rd</div>
                            <div class="text-sm" id="podium3Name">-</div>
                            <div class="text-xs" id="podium3XP">0 XP</div>
                        </div>
                    </div>

                    <!-- Full Leaderboard -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-4">Final Standings</h3>
                        <div id="finalLeaderboard" class="space-y-2">
                            <!-- Generated dynamically -->
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="startGame()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">
                            üîÑ Play Again
                        </button>
                        <button onclick="closeResults()" class="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700">
                            ‚úì Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            roomId: 'TEST-ROOM-' + Math.random().toString(36).substring(7),
            players: [],
            currentPlayer: null,
            currentQuestion: null,
            questionNumber: 0,
            timeRemaining: 0,
            isRunning: false,
            bingoGrid: [],
            unlockedSquares: [],
            completedBingos: 0,
            totalXP: 0,
        };

        // Career list for generating cards
        const careers = [
            'Chef', 'Teacher', 'Doctor', 'Nurse', 'Firefighter', 'Police Officer',
            'Programmer', 'Artist', 'Musician', 'Athlete', 'Scientist', 'Engineer',
            'Veterinarian', 'Dentist', 'Lawyer', 'Pilot', 'Architect', 'Photographer',
            'Writer', 'Mechanic', 'Electrician', 'Plumber', 'Farmer', 'Librarian'
        ];

        // Sample questions
        const sampleQuestions = [
            { clue: "I prepare delicious meals in restaurants", skill: "Culinary Arts", answer: "Chef" },
            { clue: "I help students learn and grow every day", skill: "Education", answer: "Teacher" },
            { clue: "I diagnose and treat patients in hospitals", skill: "Medicine", answer: "Doctor" },
            { clue: "I provide patient care and medical support", skill: "Healthcare", answer: "Nurse" },
            { clue: "I respond to emergencies and put out fires", skill: "Emergency Response", answer: "Firefighter" },
            { clue: "I write code and develop software applications", skill: "Technology", answer: "Programmer" },
            { clue: "I create visual art using various mediums", skill: "Creative Arts", answer: "Artist" },
            { clue: "I perform music for audiences", skill: "Performance Arts", answer: "Musician" },
            { clue: "I conduct experiments and research", skill: "Scientific Method", answer: "Scientist" },
            { clue: "I design and build structures and systems", skill: "Engineering", answer: "Engineer" },
            { clue: "I care for sick and injured animals", skill: "Animal Healthcare", answer: "Veterinarian" },
            { clue: "I maintain oral health for patients", skill: "Dental Care", answer: "Dentist" },
            { clue: "I represent clients in legal matters", skill: "Legal Practice", answer: "Lawyer" },
            { clue: "I fly aircraft safely to destinations", skill: "Aviation", answer: "Pilot" },
            { clue: "I design buildings and spaces", skill: "Architectural Design", answer: "Architect" },
            { clue: "I capture moments through photography", skill: "Visual Media", answer: "Photographer" },
            { clue: "I create stories and written content", skill: "Writing", answer: "Writer" },
            { clue: "I repair and maintain vehicles", skill: "Automotive Repair", answer: "Mechanic" },
            { clue: "I install and fix electrical systems", skill: "Electrical Work", answer: "Electrician" },
            { clue: "I work with pipes and water systems", skill: "Plumbing", answer: "Plumber" },
        ];

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function generateBingoCard(userCareer = null) {
            // If no user career provided (for testing), pick a random one
            if (!userCareer) {
                userCareer = careers[Math.floor(Math.random() * careers.length)];
            }

            // Create 5x5 grid with random careers
            const card = [];
            const usedCareers = new Set();

            // Reserve user's career for center square
            usedCareers.add(userCareer);

            for (let i = 0; i < 5; i++) {
                const row = [];
                for (let j = 0; j < 5; j++) {
                    // Center square (2,2) is user's chosen career (free space)
                    if (i === 2 && j === 2) {
                        row.push(userCareer);
                        continue;
                    }

                    let career;
                    do {
                        career = careers[Math.floor(Math.random() * careers.length)];
                    } while (usedCareers.has(career));
                    usedCareers.add(career);
                    row.push(career);
                }
                card.push(row);
            }

            return card;
        }

        function renderBingoCard() {
            const grid = document.getElementById('myBingoGrid');
            grid.innerHTML = '';

            gameState.bingoGrid.forEach((row, rowIdx) => {
                row.forEach((career, colIdx) => {
                    const square = document.createElement('div');
                    const isCenter = rowIdx === 2 && colIdx === 2;
                    const isUnlocked = gameState.unlockedSquares.some(
                        s => s.row === rowIdx && s.col === colIdx
                    );

                    square.className = `bingo-square ${isCenter ? 'center' : ''} ${isUnlocked ? 'unlocked' : 'bg-gray-100'}`;
                    square.innerHTML = isCenter
                        ? `<div class="text-xl mb-1">${getCareerIcon(career)}</div><div class="career-name font-semibold" title="${career}">${career}</div><div class="text-xs mt-1">‚≠ê MY CAREER</div>`
                        : `<div class="text-xl mb-1">${getCareerIcon(career)}</div><div class="career-name font-semibold" title="${career}">${career}</div>`;

                    if (!isCenter && !isUnlocked && gameState.isRunning) {
                        square.classList.add('cursor-pointer', 'hover:bg-purple-100');
                        square.onclick = () => handleSquareClick(rowIdx, colIdx, career);
                    }

                    grid.appendChild(square);
                });
            });
        }

        function getCareerIcon(career) {
            const icons = {
                'Chef': 'üë®‚Äçüç≥', 'Teacher': 'üë©‚Äçüè´', 'Doctor': 'üë®‚Äç‚öïÔ∏è', 'Nurse': 'üë©‚Äç‚öïÔ∏è',
                'Firefighter': 'üë®‚Äçüöí', 'Police Officer': 'üëÆ', 'Programmer': 'üë®‚Äçüíª',
                'Artist': 'üë®‚Äçüé®', 'Musician': 'üë®‚Äçüé§', 'Athlete': '‚õπÔ∏è', 'Scientist': 'üë®‚Äçüî¨',
                'Engineer': 'üë®‚Äçüîß', 'Veterinarian': 'üë®‚Äç‚öïÔ∏è', 'Dentist': 'ü¶∑', 'Lawyer': '‚öñÔ∏è',
                'Pilot': 'üë®‚Äç‚úàÔ∏è', 'Architect': 'üìê', 'Photographer': 'üì∑', 'Writer': '‚úçÔ∏è',
                'Mechanic': 'üîß', 'Electrician': '‚ö°', 'Plumber': 'üîß', 'Farmer': 'üë®‚Äçüåæ',
                'Librarian': 'üìö'
            };
            return icons[career] || 'üíº';
        }

        function handleSquareClick(row, col, career) {
            if (!gameState.isRunning || !gameState.currentQuestion) return;
            if (gameState.userAnswered) return; // Already answered this question

            const isCorrect = career === gameState.currentQuestion.answer;

            addEventLog(isCorrect ? '‚úÖ' : '‚ùå', `You clicked ${career}. ${isCorrect ? 'Correct!' : 'Incorrect!'}`);

            if (isCorrect) {
                gameState.unlockedSquares.push({ row, col });
                gameState.totalXP += 10;
                gameState.players[0].correctAnswers++;
                checkForBingos();
                renderBingoCard();
                updateStats();
                renderPlayersList();
            } else {
                gameState.players[0].incorrectAnswers++;
            }

            gameState.userAnswered = true; // Mark that user has answered
        }

        function checkForBingos() {
            // Initialize tracking arrays if needed
            if (!gameState.completedRows) gameState.completedRows = [];
            if (!gameState.completedCols) gameState.completedCols = [];
            if (!gameState.completedDiags) gameState.completedDiags = [];

            // Check rows
            for (let row = 0; row < 5; row++) {
                if (gameState.bingoGrid[row].every((_, col) =>
                    gameState.unlockedSquares.some(s => s.row === row && s.col === col)
                )) {
                    if (!gameState.completedRows.includes(row)) {
                        gameState.completedBingos++;
                        gameState.totalXP += 50;
                        gameState.players[0].totalXP = gameState.totalXP;
                        gameState.completedRows.push(row);
                        addEventLog('üéâ', `You completed row ${row + 1}! +50 XP`);
                    }
                }
            }

            // Check columns
            for (let col = 0; col < 5; col++) {
                if (gameState.bingoGrid.every((row, rowIdx) =>
                    gameState.unlockedSquares.some(s => s.row === rowIdx && s.col === col)
                )) {
                    if (!gameState.completedCols.includes(col)) {
                        gameState.completedBingos++;
                        gameState.totalXP += 50;
                        gameState.players[0].totalXP = gameState.totalXP;
                        gameState.completedCols.push(col);
                        addEventLog('üéâ', `You completed column ${col + 1}! +50 XP`);
                    }
                }
            }

            // Check diagonal (top-left to bottom-right): [0,0], [1,1], [2,2], [3,3], [4,4]
            const diag1Positions = [[0,0], [1,1], [2,2], [3,3], [4,4]];
            if (diag1Positions.every(([r, c]) =>
                gameState.unlockedSquares.some(s => s.row === r && s.col === c)
            )) {
                if (!gameState.completedDiags.includes('diag1')) {
                    gameState.completedBingos++;
                    gameState.totalXP += 50;
                    gameState.players[0].totalXP = gameState.totalXP;
                    gameState.completedDiags.push('diag1');
                    addEventLog('üéâ', 'You completed a diagonal! +50 XP');
                }
            }

            // Check diagonal (top-right to bottom-left): [0,4], [1,3], [2,2], [3,1], [4,0]
            const diag2Positions = [[0,4], [1,3], [2,2], [3,1], [4,0]];
            if (diag2Positions.every(([r, c]) =>
                gameState.unlockedSquares.some(s => s.row === r && s.col === c)
            )) {
                if (!gameState.completedDiags.includes('diag2')) {
                    gameState.completedBingos++;
                    gameState.totalXP += 50;
                    gameState.players[0].totalXP = gameState.totalXP;
                    gameState.completedDiags.push('diag2');
                    addEventLog('üéâ', 'You completed a diagonal! +50 XP');
                }
            }
        }

        function simulateOtherPlayerClicks() {
            // AI players answer at random times during the question
            gameState.players.forEach((player, idx) => {
                if (player.id === 'you') return;

                // Random delay between 1-8 seconds
                const delay = Math.random() * 7000 + 1000;
                setTimeout(() => {
                    if (!gameState.isRunning || !gameState.currentQuestion) return;
                    if (gameState.currentQuestion !== gameState.lastQuestion) return; // Question changed

                    const accuracy = player.aiDifficulty === 'easy' ? 0.5 :
                                   player.aiDifficulty === 'medium' ? 0.7 : 0.85;
                    const isCorrect = Math.random() < accuracy;

                    if (isCorrect) {
                        player.correctAnswers++;
                        player.totalXP += 10;
                        addEventLog('‚úÖ', `${player.name} answered correctly!`);
                    } else {
                        player.incorrectAnswers++;
                        addEventLog('‚ùå', `${player.name} answered incorrectly`);
                    }
                    renderPlayersList();
                }, delay);
            });
        }

        function generatePlayers() {
            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            const aiNames = ['Aaron B.', 'Jessica M.', 'Marcus L.', 'Sophia K.', 'Tyler R.', 'Emma W.', 'David C.', 'Maya P.'];
            const difficulties = ['easy', 'medium', 'hard'];

            gameState.players = [
                {
                    id: 'you',
                    name: 'You',
                    isAI: false,
                    totalXP: 0,
                    correctAnswers: 0,
                    incorrectAnswers: 0,
                    bingosWon: 0,
                }
            ];

            for (let i = 1; i < numPlayers; i++) {
                gameState.players.push({
                    id: `ai-${i}`,
                    name: aiNames[i - 1] || `Bot ${i}`,
                    isAI: true,
                    aiDifficulty: difficulties[Math.floor(Math.random() * difficulties.length)],
                    totalXP: 0,
                    correctAnswers: 0,
                    incorrectAnswers: 0,
                    bingosWon: 0,
                });
            }

            gameState.currentPlayer = gameState.players[0];
        }

        function renderPlayersList() {
            const list = document.getElementById('playersList');
            const sorted = [...gameState.players].sort((a, b) => b.totalXP - a.totalXP);

            list.innerHTML = sorted.map((player, idx) => `
                <div class="player-card ${player.id === 'you' ? 'current-user' : ''} p-3 rounded-lg ${player.id === 'you' ? '' : 'bg-gray-50'}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`}</span>
                            <div>
                                <div class="font-bold">${player.name} ${player.isAI ? 'ü§ñ' : ''}</div>
                                <div class="text-xs text-gray-600">${player.correctAnswers}/${player.correctAnswers + player.incorrectAnswers} correct</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-purple-600">${player.totalXP} XP</div>
                            <div class="text-xs text-yellow-600">${player.bingosWon || 0} bingos</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addEventLog(icon, message) {
            const log = document.getElementById('eventLog');
            const firstChild = log.firstElementChild;
            if (firstChild && firstChild.textContent.includes('No events')) {
                log.innerHTML = '';
            }

            const entry = document.createElement('p');
            entry.className = 'text-xs bg-gray-50 p-2 rounded';
            entry.innerHTML = `<span class="font-bold">${icon}</span> ${message}`;
            log.insertBefore(entry, log.firstChild);

            // Keep only last 20 entries
            while (log.children.length > 20) {
                log.removeChild(log.lastChild);
            }
        }

        function updateStats() {
            document.getElementById('unlockedCount').textContent = gameState.unlockedSquares.length;
            document.getElementById('bingoCount').textContent = gameState.completedBingos;
            document.getElementById('xpCount').textContent = gameState.totalXP;
        }

        function nextQuestion() {
            if (gameState.questionNumber >= parseInt(document.getElementById('numQuestions').value)) {
                endGame();
                return;
            }

            gameState.questionNumber++;
            gameState.currentQuestion = sampleQuestions[(gameState.questionNumber - 1) % sampleQuestions.length];
            gameState.lastQuestion = gameState.currentQuestion; // Track for AI answers
            gameState.timeRemaining = parseInt(document.getElementById('timerDuration').value);
            gameState.userAnswered = false; // Reset for new question

            document.getElementById('questionNumber').textContent = gameState.questionNumber;
            document.getElementById('questionText').textContent = gameState.currentQuestion.clue;
            document.getElementById('skillConnection').textContent = `Skill: ${gameState.currentQuestion.skill}`;
            document.getElementById('gameState').textContent = `Playing - Question ${gameState.questionNumber}`;

            addEventLog('üì¢', `Question ${gameState.questionNumber}: ${gameState.currentQuestion.clue}`);

            // Start AI players answering at random times
            simulateOtherPlayerClicks();

            startTimer();
        }

        function startTimer() {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);

            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                document.getElementById('timerDisplay').textContent = gameState.timeRemaining + 's';

                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timerInterval);
                    addEventLog('‚è∞', 'Time expired!');
                    setTimeout(nextQuestion, 1500); // Move to next question after 1.5s
                }
            }, 1000);
        }

        function startGame(userCareer = null) {
            // TODO: In production, get userCareer from user session/profile
            // For testing, we'll use a random career or passed parameter

            // Reset state
            gameState = {
                roomId: gameState.roomId,
                players: [],
                currentPlayer: null,
                currentQuestion: null,
                questionNumber: 0,
                timeRemaining: 0,
                isRunning: true,
                bingoGrid: generateBingoCard(userCareer),
                unlockedSquares: [{row: 2, col: 2}], // Center square is always unlocked (user's career)
                completedBingos: 0,
                totalXP: 0,
                completedRows: [],
                completedCols: [],
                completedDiags: [],
            };

            document.getElementById('resultsModal').classList.add('hidden');
            document.getElementById('gameState').textContent = 'Starting...';

            generatePlayers();
            renderBingoCard();
            renderPlayersList();
            updateStats();

            document.getElementById('eventLog').innerHTML = '<p class="text-gray-500 italic">Game starting...</p>';
            addEventLog('üéÆ', 'Game started!');
            addEventLog('üë•', `${gameState.players.length} players joined`);

            setTimeout(nextQuestion, 2000);
        }

        function endGame() {
            gameState.isRunning = false;
            clearInterval(gameState.timerInterval);

            document.getElementById('gameState').textContent = 'Game Complete!';
            addEventLog('üèÅ', 'Game complete!');

            // Update your player's stats
            gameState.players[0].totalXP = gameState.totalXP;
            gameState.players[0].bingosWon = gameState.completedBingos;

            showResults();
        }

        function showResults() {
            const sorted = [...gameState.players].sort((a, b) => b.totalXP - a.totalXP);

            // Podium
            if (sorted[0]) {
                document.getElementById('podium1Name').textContent = sorted[0].name;
                document.getElementById('podium1XP').textContent = sorted[0].totalXP + ' XP';
            }
            if (sorted[1]) {
                document.getElementById('podium2Name').textContent = sorted[1].name;
                document.getElementById('podium2XP').textContent = sorted[1].totalXP + ' XP';
            }
            if (sorted[2]) {
                document.getElementById('podium3Name').textContent = sorted[2].name;
                document.getElementById('podium3XP').textContent = sorted[2].totalXP + ' XP';
            }

            // Full leaderboard
            const leaderboard = document.getElementById('finalLeaderboard');
            leaderboard.innerHTML = sorted.map((player, idx) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg ${player.id === 'you' ? 'ring-2 ring-purple-500' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`}</span>
                        <div>
                            <div class="font-bold">${player.name} ${player.isAI ? 'ü§ñ' : 'üë§'}</div>
                            <div class="text-xs text-gray-600">
                                ${player.correctAnswers}/${player.correctAnswers + player.incorrectAnswers} correct ‚Ä¢
                                ${player.bingosWon || 0} bingos
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-purple-600">${player.totalXP} XP</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('resultsModal').classList.remove('hidden');
        }

        function closeResults() {
            document.getElementById('resultsModal').classList.add('hidden');
        }

        // Initialize on load
        window.onload = () => {
            document.getElementById('roomCode').textContent = gameState.roomId;
            addEventLog('‚úÖ', 'Test page loaded. Click "Start New Game" to begin!');
        };
    </script>
</body>
</html>
