<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube API Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .video-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .video-title {
      font-weight: bold;
      color: #1a73e8;
    }
    .video-meta {
      color: #666;
      font-size: 14px;
      margin: 5px 0;
    }
    .no-ads {
      color: green;
      font-weight: bold;
    }
    .has-ads {
      color: orange;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1557b0;
    }
    .iframe-container {
      position: relative;
      width: 100%;
      max-width: 560px;
      margin: 20px 0;
    }
    iframe {
      width: 100%;
      height: 315px;
      border: none;
      border-radius: 8px;
    }
    .pathfinity-intro {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 8px;
      z-index: 10;
    }
    .countdown {
      font-size: 48px;
      font-weight: bold;
      margin: 20px;
    }
    #results {
      white-space: pre-wrap;
      font-family: monospace;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>üé¨ YouTube Educational API Test</h1>

  <div class="test-section">
    <h2>Test Controls</h2>
    <button onclick="testSearch()">Test Search API</button>
    <button onclick="testOptimalSelection()">Test Optimal Video Selection</button>
    <button onclick="testEmbedding()">Test Video Embedding</button>
    <button onclick="clearResults()">Clear Results</button>
  </div>

  <div class="test-section">
    <h2>Results</h2>
    <div id="results">Click a test button to see results...</div>
  </div>

  <div class="test-section" id="video-section" style="display: none;">
    <h2>Video Preview</h2>
    <div id="video-container"></div>
  </div>

  <script type="module">
    // Import the YouTube service
    import { youTubeService } from './src/services/content-providers/YouTubeService.ts';

    // Expose functions to global scope for onclick handlers
    window.testSearch = async function() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.textContent = 'Searching for Kindergarten counting videos...';

      try {
        const results = await youTubeService.searchEducationalVideos('K', 'Math', 'Counting to 10');

        let output = `Found ${results.videos.length} videos:\n\n`;

        results.videos.forEach((video, index) => {
          output += `${index + 1}. ${video.title}\n`;
          output += `   Channel: ${video.channelTitle}\n`;
          output += `   Duration: ${Math.floor(video.duration / 60)}:${(video.duration % 60).toString().padStart(2, '0')}\n`;
          output += `   Views: ${video.viewCount.toLocaleString()}\n`;
          output += `   Has Ads: ${video.hasAds ? 'Yes ‚ö†Ô∏è' : 'No ‚úÖ'}\n`;
          output += `   Educational Score: ${video.educationalScore}/100\n`;
          output += `   Video ID: ${video.id}\n\n`;
        });

        resultsDiv.textContent = output;
      } catch (error) {
        resultsDiv.textContent = `Error: ${error.message}\n\nMake sure the API key is valid and has YouTube Data API v3 enabled.`;
      }
    };

    window.testOptimalSelection = async function() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.textContent = 'Finding optimal video...';

      try {
        const results = await youTubeService.searchEducationalVideos('K', 'Math', 'Counting to 10');
        const optimal = await youTubeService.selectOptimalVideo(results.videos);

        if (optimal) {
          let output = 'Optimal Video Selected:\n\n';
          output += `Title: ${optimal.title}\n`;
          output += `Channel: ${optimal.channelTitle}\n`;
          output += `Duration: ${Math.floor(optimal.duration / 60)}:${(optimal.duration % 60).toString().padStart(2, '0')}\n`;
          output += `Has Ads: ${optimal.hasAds ? 'Yes ‚ö†Ô∏è' : 'No ‚úÖ'}\n`;
          output += `Educational Score: ${optimal.educationalScore}/100\n`;
          output += `\nEmbed URL: ${optimal.embedUrl}\n`;
          output += `\nThis video was selected because:\n`;
          output += optimal.hasAds ? '' : '- No ads detected\n';
          output += optimal.duration < 480 ? '- Short duration (no mid-roll ads)\n' : '';
          output += optimal.educationalScore > 70 ? '- High educational score\n' : '';

          resultsDiv.textContent = output;
        }
      } catch (error) {
        resultsDiv.textContent = `Error: ${error.message}`;
      }
    };

    window.testEmbedding = async function() {
      const resultsDiv = document.getElementById('results');
      const videoSection = document.getElementById('video-section');
      const videoContainer = document.getElementById('video-container');

      resultsDiv.textContent = 'Loading video with Pathfinity intro...';

      try {
        const results = await youTubeService.searchEducationalVideos('K', 'Math', 'Counting to 10');
        const optimal = await youTubeService.selectOptimalVideo(results.videos);

        if (optimal) {
          videoSection.style.display = 'block';

          // Create the video container with Pathfinity intro
          videoContainer.innerHTML = `
            <div class="iframe-container">
              <div class="pathfinity-intro" id="intro">
                <h2>Sam's Marine Biology Journey</h2>
                <p>Let's learn to count the baby sea turtles!</p>
                <div class="countdown" id="countdown">10</div>
                <p>Video starts in...</p>
              </div>
              <iframe
                id="youtube-player"
                src="${optimal.embedUrl}?modestbranding=1&rel=0&start=10&autoplay=0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                style="visibility: hidden;">
              </iframe>
            </div>
            <div class="video-meta">
              <div class="video-title">${optimal.title}</div>
              <div>Channel: ${optimal.channelTitle}</div>
              <div class="${optimal.hasAds ? 'has-ads' : 'no-ads'}">
                ${optimal.hasAds ? '‚ö†Ô∏è May contain ads' : '‚úÖ Ad-free video'}
              </div>
            </div>
          `;

          // Countdown timer
          let countdown = 10;
          const countdownElement = document.getElementById('countdown');
          const intro = document.getElementById('intro');
          const iframe = document.getElementById('youtube-player');

          const timer = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;

            if (countdown === 0) {
              clearInterval(timer);
              intro.style.display = 'none';
              iframe.style.visibility = 'visible';

              // Update the iframe src to trigger autoplay
              iframe.src = iframe.src.replace('autoplay=0', 'autoplay=1');
            }
          }, 1000);

          resultsDiv.textContent = 'Video embedded successfully! Watch the 10-second intro above.';
        }
      } catch (error) {
        resultsDiv.textContent = `Error: ${error.message}`;
      }
    };

    window.clearResults = function() {
      document.getElementById('results').textContent = 'Results cleared. Click a test button to run tests.';
      document.getElementById('video-section').style.display = 'none';
      document.getElementById('video-container').innerHTML = '';
    };
  </script>
</body>
</html>